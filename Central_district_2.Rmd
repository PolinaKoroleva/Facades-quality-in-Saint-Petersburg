---
title: "Central_District"
date: "07/05/2020"
runtime: shiny
output: html_document
---
###### __Анализ__: *Королева* *Полина*, *аналитик* *данных*
###### __Постановка__ __задачи__: *Скатин* *Андрей*, *начальник* *отдела* *информатизации* *и* *связи*; *Корякин* *Станислав*, *продюсер* *проектов* *развития*
###### __Методологическая поддержка__: *Корякин* *Станислав*, *продюсер* *проектов* *развития*

---------------

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```
#### Введение в проблематику

Содержание и эксплуатация жилищного фонда являются одним из основных и наиболее интересующих жителей города направлений работы администрации. В Центральном районе этот вопрос особенно актуален - это самый старый район Санкт-Петербурга, который на 93% представлен объектами дореволюционной постройки.

Для ремонта, в первую очередь, исторических зданий в 2019 году была запущена программа "Фасады Петербурга". Однако две основные проблемы для её реализации - финансирование и комплексность. Для ремонта фасадов ежегодно потребуется около 1,7 млрд рублей - это 2/3 всего реставрационного бюджета КГИОП. Для решения проблемы комплексности был составлен список исторических зданий, подлежащих ремонту в первую очередь.

Вместе с тем, на портале для жалоб и обращений горожан "Наш Санкт-Петербург" скопилось значительное число неудовлетворенных заявок на качество жилого фонда. В первую очередь, большое количество жалоб жителей района связано с неудовлетворительным состоянием фасадов. В условиях ограниченных финансовых ресурсов возникла необходимость в системе поддержки принятия решений для приоритизации адресов ремонтов. 

**Проблема**: Дефицит ресурсов для одномоментного ремонта всего жилого фонда и отсутствие инструментов объективной приоритезации адресов ремонтов.    
**Постановка задачи**: Апробировать систему поддержки принятия решений, основанной на  анализе данных.Предложить основания и алгоритм принятия решений по программе ремонта фасадов.      
**Данные**: Обращения граждан через портал "Наш Санкт-Петербург" за 2015-2019 годы.    

Для исследования предложены две гипотезы:  
        1. Наиболее высокая концентрация жалоб является значимым признаком для принятия решений о ремонте.   
        2. Наиболее долгий период времени обработки обращения (характеризуются наиболее длинным промежутком между первым и последним сообщением) является значимым признаком для принятия решений о ремонте.  

Для проверки этих гипотез необходимо составить карту обращений, исходя из адресов, по которым они поступают. Так можно выявить кластеры на карте района, где наиболее высокая концентрация проблем проблем (Гипотеза 1). Для проверки Гипотезы 2, необходимо вычислить количество дней, прошедших между первым и последним сообщением и соотнести их с видом проблемы и местом на карте. Также удобным инструментом для принятия решения о том, какие фасады ремонтировать в первую очередь,  является анализ и визуализация взаимотношения отдельных переменных, таких как _Статус проблемы_, _Год_, _Объект_ и другие.  
        
По результатам проверки гипотез были сформированы основания для принятия решений при направлении ресурсов для ремонту.

#### Анализ данных обращений
##### Подготовка данных
```{r library, include=FALSE}
library(readxl)
library(dplyr)
library(magrittr)
library(leaflet)
library(ggplot2)
library(stringr)
library(rsconnect)
library(shiny)
```

Загружены данные всех обращений граждан Центрального района, и выбраны те переменные, которые подходят для анализа. Они включают в себя:

```{r data, echo=FALSE}
fasades <- read_excel("ИТМО_НАШ_СПБ.xlsx")
# Выбираем нужные переменные для анализа
fas <- select(fasades, Объект:Причина, Адрес:ends_with("последнего сообщения"), contains("Год"))
names(fas) <- gsub(" ", "_", names(fas))
colnames(fas)
```

Выбераем те категории, которые могут быть использованы для характеристики проблем, связанных с фасадами. Это **Объекты**: _Дом_ и _Сооружение_, **Категории** - _Благоустройство_ и _Фасад_. В результате получаем базу данных размерностью:

```{r fas columns, echo=FALSE}
data1<- fas %>% filter((Объект == "Дом"| Объект == "Сооружение") 
& (Категория == "Благоустройство"|Категория == "Фасад" ))
dim(data1)
```
```{r fas factors, include = FALSE}
# Переводим в формат факторов и дат
data1 <- data1 %>%
        mutate_at(vars(Объект, Категория, Причина, Статус_проблемы, Год),
                  as.factor) 

data1$Ответ_до <- as.POSIXlt(data1$Ответ_до,tz=Sys.timezone(), "%d.%m.%Y")
data1$Дата_первого_сообщения <- as.POSIXlt(data1$Дата_первого_сообщения,tz=Sys.timezone(), "%d.%m.%Y %H:%M")
data1$Дата_последнего_сообщения <- as.POSIXlt(data1$Дата_последнего_сообщения,tz=Sys.timezone(), "%d.%m.%Y %H:%M")
```


##### Оценка взаимодействия разных факторов. Причины обращений

Из распределения обращений по типу объектов видно, что большинство жалоб касаются домов, в том числе, обращение "125. Неудовлетворительносе состояние окраски фасадов".

```{r plot1, echo = FALSE}
ggplot(data1) +
        geom_bar(aes(x = Объект, fill = Причина), position = "dodge")+
        theme(legend.text = element_text(size = 4),
              legend.title = element_text(size = 8),
              legend.position = c(1, 0.98),
              legend.justification = c("right", "top"),
              legend.box.just = "right",
              legend.margin = margin(2, 2, 2, 2),
              legend.key.size = unit(0.3, "cm"),
              axis.text.x = element_text(size = 7),
              axis.title.x = element_text(size = 8),
              axis.text.y = element_text(size = 7),
              axis.title.y = element_text(size = 8)) +
        labs (title = "Распределение причин обращений по типу объектов", y = "Количество обращений")
```

##### Распределение количества обращений по годам и причины этих обращений

Количество обращений в целом увеличивалось каждый год, особенно заметно увеличенией обращений по проблемам 125 и 80 (состояние окраски фасадов и несанкционированные надписи). Эта динамика может свидетельствовать о том, что данные проблемы чаще всего встречаются и значительно волнуют жителей.

```{r plot 2, echo = FALSE}
ggplot(data1) +
        geom_bar(aes(x = Год, fill = Причина),
                 position = "dodge")+
        theme(legend.text = element_text(size = 4.5),
              legend.title = element_text(size = 8),
              legend.position = c(.05, .95),
              legend.justification = c("left", "top"),
              legend.box.just = "right",
              legend.margin = margin(2, 2, 2, 2),
              legend.key.size = unit(0.4, "cm"),
              axis.text.x = element_text(size = 8),
              axis.title.x = element_text(size = 10),
              axis.text.y = element_text(size = 9),
              axis.title.y = element_text(size = 10)) +
        labs(title = "Распределение причин обращений по годам", y = "Количество обращений")
```

##### Время ожидания решения проблемы

Важной характеристикой обращений является информация о первом и последнем обращении. Так возможно оценить, какие проблемы решаются дольше. Возможно, из-за долгого ожидания решения или ответа по проблему, по одному и тому же кейсу поступают новые обращения. Поэтому была создана новая переменная `wait2`, которая насчитывает количество дней между первым и последним обращением.  

```{r wait, include=FALSE}
data2 <- mutate(data1, wait = as.POSIXct(Дата_последнего_сообщения) -
                        as.POSIXct(Дата_первого_сообщения))
str(data2)
data2$wait2 <- difftime(data1$Дата_последнего_сообщения, data1$Дата_первого_сообщения, units = "days")
```

Чтобы оценить, сколько дней проходит от первого до последнего сообщения, рассчитываем среднее время ожидания для каждого типа обращения. На графике ниже видно, что самое высокое среднее время ожидания  относится к исключенным проблемам (видим, может игнорироваться) и отсутвию адресной вывески. Обсуждение обращений №125 (состояние окраски фасадов) в среднем обрабатывается быстрее всего. 

```{r wait mean, echo = FALSE}
data2$Причина_num <- as.numeric(data2$Причина)
wait_mean <- data2 %>% 
        group_by(Причина_num) %>% 
        summarise(Ожидание= mean(wait2))
wait_mean$Причина <- levels(data2$Причина)


ggplot(wait_mean)+
        geom_bar(
                mapping = aes(
                        x = Причина_num,
                        y = Ожидание, color = Причина, fill = Причина), 
                stat = "Identity")+
        theme(legend.text = element_text(size = 4.5),
              legend.title = element_text(size = 8),
              legend.position = c(.05, .95),
              legend.justification = c("left", "top"),
              legend.box.just = "right",
              legend.margin = margin(2, 2, 2, 2),
              legend.key.size = unit(0.4, "cm"),
              axis.text.x = element_text(size = 8),
              axis.title.x = element_text(size = 10),
              axis.text.y = element_text(size = 9),
              axis.title.y = element_text(size = 10)) +
        labs(title = "Среднее время ожидания решения проблемы",
             y = "Среднее Ожидание, дни",
             x = "Причина обращения")
```

Для оценки изменений в статусе обращений за каждый год построен график:

```{r plot year-status, echo = FALSE}
ggplot(data2)+
        geom_bar(aes(Год, fill = Статус_проблемы), 
                 position = position_dodge(width = 0.9))+
        labs(title = "Распределение статуса проблемы за 2015 - 2019 год", 
             y = "Количество обращений")

```

##### Распределение статуса проблемы по причинам обращений

Большинство обращений по состоянию архитектурных элементов (124), состоянию окраски фасадов (125) и герметизации стыков (186), повреждение участков цоколя (187) - находятся на стадии промежуточного ответа. Остальные обращения - в большинстве своём на стадии рассмотрения.

```{r plot reason-status, echo = FALSE}
ggplot(data2)+
        geom_bar(aes(Причина_num, fill = Статус_проблемы, color = Причина),size=2, alpha = 0.8, 
        position = position_dodge(width = 0.9))+
        labs(title = "Причина обращения и статус проблемы", 
             y = "Количество обращений",
             x = "Причина обращения")+
        theme(legend.text = element_text(size = 4),
              legend.title = element_text(size = 7),
              legend.position = c(1, .98),
              legend.justification = c("right", "top"),
              legend.box.just = "right",
              legend.margin = margin(0, 0, 0, 0),
              legend.key.size = unit(0.3, "cm"),
              axis.text.x = element_text(size = 8),
              axis.title.x = element_text(size = 10),
              axis.text.y = element_text(size = 9),
              axis.title.y = element_text(size = 10))
     
```

##### Отображение данных на карте 

Следующим этапом анализа было геокодирование, необходимое для визуализации локаций адресов, по которым поступили обращения.

```{r add adress, include = FALSE}
# Загружаем данные
address<- read.csv("out.csv")
# Делим координаты по столбцам
address$clean_coords <- gsub(pattern = '[()]', replacement = '', x = address$coordinates)
# Cоздаём отдельную таблицу только с координатами
split_coords <- str_split(string = address$clean_coords, 
                         pattern = ',', n = 2, simplify = TRUE)
split_coords <- gsub("\'", "", x = split_coords)
split_coords <- as.data.frame(split_coords)
names(split_coords) <- c("lng", "lat")
split_coords$lat<-as.character(as.factor(split_coords$lat))
split_coords$lng <-as.character(as.factor(split_coords$lng))
str(split_coords)

# Переводим координаты в численный формат (читаемый leaflet)
coordinates_num <-data.frame(lng = as.numeric(split_coords$lng))
coordinates_num$lat <-(as.numeric(split_coords$lat))
head(coordinates_num)

combined <- data.frame(data2, coordinates_num)
str(combined)
```

```{r map, echo=FALSE}
combined %>% leaflet() %>% 
        addTiles() %>% 
        addCircleMarkers()
```

Выделены кластеры из территорий, по которым было заявлено больше всего обращений. Это округ Смольнинское, Лиговка-Ямская и Владимирский округ. 

```{r map clust, echo=FALSE}
combined %>% leaflet() %>% 
        addTiles() %>% 
        addMarkers(clusterOptions = markerClusterOptions())
```

##### Распределение обращений на карте по типу их причин

```{r map причина, echo=FALSE}
factpal <- colorFactor(topo.colors(8), combined$Причина)

leaflet(combined) %>%
        addTiles() %>%
        addCircles(fillOpacity = 0.9,
                    color = ~factpal(combined$Причина)) %>% 
        addLegend("bottomright", pal = factpal, values = ~ Причина, 
                  title = "Причина обращения", opacity = 0.5) 

```

##### Распределение обращений по адресам

Цвет точек характерезует причины обращений. Размер  - длину ожидания между первым и последним сообщением о проблеме. Так мы можем видеть концентрации обращений по отдельным проблемам, и какие из них решались дольше всего.

```{r map причина-ожидание, echo=FALSE}
factpal <- colorFactor(topo.colors(8), combined$Причина)

leaflet(combined) %>%
        addTiles() %>%
        addCircles(fillOpacity = 0.7, stroke = FALSE,
                    color = ~factpal(combined$Причина), weight = 10, radius = (combined$wait2)) %>% 
        addLegend("bottomright", pal = factpal, values = ~ Причина, 
                  title = "Причина обращения", opacity = 0.5) 

```

##### Распределение обращений по годам

```{r map year, echo=FALSE}
factpalyear <- colorFactor(rainbow(5), as.factor(combined$Год))

leaflet(combined) %>%
        addTiles() %>%
        addCircles(fillOpacity = 1,
                    color = ~factpalyear(as.factor(combined$Год)), weight = 5) %>% 
        addLegend("bottomright", pal = factpalyear, values = ~ Год, 
                  title = "Год обращения", opacity = 0.5) 

```
Обращения обозначены цветами, соответствующим разным годам. Радиус окружностей отвечает за продолжительность ожидания между первым и последним сообщением о проблеме. Чем больше радиус, тем больше ожидание. Так можно заметить, что наибольшее время решения проблемы характерно для 2018 года, и для таких округов как Лиговский, Владимирский, Площадь Восстания, округ Смольнинское.

```{r map year wait, echo=FALSE}

leaflet(combined) %>%
        addTiles() %>%
        addCircles(stroke = FALSE, fillOpacity = 0.7,
                    color = ~factpalyear(as.factor(combined$Год)),radius = (combined$wait2)) %>% 
        addLegend("bottomright", pal = factpalyear, values = ~ Год, 
                  title = "Год обращения", opacity = 0.5) 

```


#### Выводы и рекомендации

Проведён анализ обращений граждан за 2015-2019 годы по проблемам состояния фасадов домов. На его основании подготовлены рекомендации для поддержки принятия решений при направлении ресурсов для ремонту. При помощи инструментов визуализации было выявлено распределение обращений в зависимости от года, причины, времени ожидания и статуса решения проблемы. Также были обнаружены кластеры из "проблемных" адресов, по которым поступает больше всего обращений (гипотеза 1), и кластеры адресов домов, по которым проблема решалась дольше всего (гипотеза 2). На основе этих гипотез сформулированы основания для приоретизации локаций для ремонта.  

Возможный вариант использования результатов анализа может быть оформлен в следующий алгоритм приоритезации ремонтов (прототип Системы принятия решений):  
1. Высокий приоритет проведения ремонтов: адреса, где пересекаются оба выявленных основания - наибольшее количество обращений и наиболее длительные сроки ожидания ремонтов.   
2. Средний приоритет: адреса, где выявлено наибольшее количество обращений.   
3. Обычный приоритет: адреса, где зафиксированы наиболее длительные сроки ожидания ремонтов.

Указанная преоритезация может помочь эффективно направить ресурсы по необходимым адресам. Однако веса указанных оснований зависят от факторов, которые не являлись предметом настоящего исследования и требуют дальнейшей проработки в сотрудничестве с администрацией Центрального района СПб. 

#### Внедрение в Центральном районе

Проект был представлен администрации Центрального района Санкт-Петербурга. Разработанная модель получила поддержку, но в ближайшее время внедрение не представлется возможным в связи с отсутствием нормативной базы. 

#### Потенциал использования результата данной работы

Представлен подход к системе поддержки принятия решений на основе данных. Это объективированная аргументация, которая может дать возможность:  
  - Верифицировать решения, принятые муниципальными и государственными служащими;  
  - Дать муниципальным и государственным служащим понятные, прозрачные и легитимные               основания для принятия решений.  
Для системы автоматизации принятия решений требуется проведение  более углубленного изучения ситуации и проектирование, в том числе с учетом локальных НПА.  

 
#### Возможное развитие исследования

1. Провести кластерный анализ данных, чтобы выявить паттерны взаимосвязей среди переменных.
2. Дополнить базу данных информацией о последнем капитальном ремонте,информация о подрядчике (оценка качества выполняемых работ), дате постройки дома. 
3. Рассмотреть переменную о пренадлежности дома к зданиям федерального, регионального значения, культурного наследия. Возможно, такие дома быстрее приводят в порядок, или наоборот, задерживается принятие решения из-за большого количества согласований. 
4. На качество фасада также могут влиять такие переменные, как близость загруженной дороги, трамвайных линий. Эти переменные могут быть использованы для составления прогноза срока "изнашивания" фасада и быстрого реагирования.

